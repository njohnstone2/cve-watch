package main

import (
	"errors"

	"github.com/urfave/cli/v2"
)

type Config struct {
	SlackToken     string `json:"slack_token"`
	SlackChannelId string `json:"slack_channel_id"`
	LogLevel       string `json:"log_level"`
	LogFormat      string `json:"log_format"`
	IntervalMins   int    `json:"interval_mins"`
	HTTPPort       int    `json:"http_port"`
}

func DefaultConfig() Config {
	return Config{
		LogLevel:     "info",
		LogFormat:    "text",
		IntervalMins: 5,
		HTTPPort:     8080,
	}
}

func (config *Config) Parameters() []cli.Flag {
	defaults := DefaultConfig()

	return []cli.Flag{
		&cli.StringFlag{
			Name:        "slack-token",
			Usage:       "Slack bot token",
			EnvVars:     []string{"SLACK_TOKEN"},
			Value:       defaults.SlackToken,
			Destination: &config.SlackToken,
		},
		&cli.StringFlag{
			Name:        "slack-channel-id",
			Usage:       "Slack channel ID",
			EnvVars:     []string{"SLACK_CHANNEL_ID"},
			Value:       defaults.SlackChannelId,
			Destination: &config.SlackChannelId,
		},
		&cli.StringFlag{
			Name:        "log-level",
			Usage:       "Application log level. Default: info",
			EnvVars:     []string{"LOG_LEVEL"},
			Value:       defaults.LogLevel,
			Destination: &config.LogLevel,
		},
		&cli.StringFlag{
			Name:        "log-format",
			Usage:       "Application log format. Default: text",
			EnvVars:     []string{"LOG_FORMAT"},
			Value:       defaults.LogFormat,
			Destination: &config.LogFormat,
		},
		&cli.IntFlag{
			Name:        "interval-mins",
			Usage:       "Frequency the NVD API should be polled. Deault: 5",
			EnvVars:     []string{"INTERVAL_MINS"},
			Value:       defaults.IntervalMins,
			Destination: &config.IntervalMins,
		},
		&cli.IntFlag{
			Name:        "http-port",
			Usage:       "HTTP Port that is used for health checks",
			EnvVars:     []string{"HTTP_PORT"},
			Value:       defaults.HTTPPort,
			Destination: &config.HTTPPort,
		},
	}
}

func (config *Config) Validate() error {
	if config.SlackToken == "" {
		return errors.New("slack bot token must be provided")
	}

	if config.SlackChannelId == "" {
		return errors.New("slack channel ID must be provided")
	}

	return nil
}
